---
title: "[Server] #15-9. ì´ë²¤íŠ¸ì™€ ì¡°ê±´ ë³€ìˆ˜"
excerpt: "Producer & Consumer íŒ¨í„´ìœ¼ë¡œ ì´ë²¤íŠ¸ì™€ ì¡°ê±´ ë³€ìˆ˜ í™œìš©í•˜ê¸°"

categories:
  - Server
tags:
  - [Server, Event, ConditionVariable]

permalink: /theory/server/event-and-condition-variable/

toc: true
toc_sticky: true

date: 2024-11-13
last_modified_at: 2025-03-14
---

## ì´ë²¤íŠ¸ì™€ ì¡°ê±´ ë³€ìˆ˜

ë©€í‹° ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ê³µìœ í•˜ë©´ì„œ ëŒ€ê¸° ì‹œê°„ì„ ì¤„ì´ëŠ” ë°©ë²•ì„ ì•Œì•„ë³¸ë‹¤. ì´ë²ˆì—ëŠ” Producer & Consumer íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ ì´ë²¤íŠ¸(Event)ì™€ ì¡°ê±´ ë³€ìˆ˜(Condition Variable)ì„ í™œìš©í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì.

---

### Producer & Consumer

ìƒì‚°ìì™€ ì†Œë¹„ìë¡œ ì—­í• ì„ ë¶„ë‹´í•˜ë©´, ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ë©´ì„œë„ ë½ ê²½í•©ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.

&nbsp;

ê¸°ë³¸ì ì¸ Producer & Consumer íŒ¨í„´ì„ ì½”ë“œë¡œ êµ¬í˜„í•´ë³´ì.

- `Producer()`
  - ë¬´í•œ ë£¨í”„ë¥¼ ëŒë©° íì— ë°ì´í„°ë¥¼ ë„£ëŠ”ë‹¤.
  - `std::unique_lock<std::mutex>`ë¥¼ ì‚¬ìš©í•´ ë®¤í…ìŠ¤ë¥¼ ì ê·¸ê³ , íì— ë°ì´í„°(`100`)ë¥¼ ë„£ì€ í›„ ì ê¸ˆì„ í•´ì œí•œë‹¤.
  - ë°ì´í„°ë¥¼ ë„£ì€ í›„ 100ms ë™ì•ˆ ì ë“ ë‹¤.
- `Consumer()`
  - ë¬´í•œ ë£¨í”„ë¥¼ ëŒë©° íì—ì„œ ë°ì´í„°ë¥¼ êº¼ë‚¸ë‹¤.
  - `std::unique_lock<std::mutex>`ë¥¼ ì‚¬ìš©í•´ ë®¤í…ìŠ¤ë¥¼ ì ê·¸ê³ , íê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ ë°ì´í„°ë¥¼ êº¼ë‚´ì„œ ì¶œë ¥í•œë‹¤.
  - íê°€ ë¹„ì–´ìˆìœ¼ë©´ ì•„ë¬´ëŸ° ì‘ì—…ë„ í•˜ì§€ ì•ŠëŠ”ë‹¤.

```cpp
std::mutex m;
std::queue<int> q;

void Producer()
{
	while (true)
	{
		std::unique_lock<std::mutex> lock(m);
		q.push(100);
		std::this_thread::sleep_for(100ms);
	}
}

void Consumer()
{
	while (true)
	{
		std::unique_lock<std::mutex> lock(m);
		if (q.empty() == false)
		{
			int data = q.front();
			q.pop();
			std::cout << data << std::endl;
		}
	}
}

int main()
{
	std::thread t1(Producer);
	std::thread t2(Consumer);

	t1.join();
	t2.join();
}
```

- ë¬¸ì œì 
  - Busy Waiting
    - ì†Œë¹„ì ìŠ¤ë ˆë“œëŠ” íê°€ ë¹„ì–´ìˆì„ ë•Œë„ ë¬´í•œ ë£¨í”„ë¥¼ ëŒë©´ì„œ íë¥¼ í™•ì¸í•œë‹¤. ì•„ëŠ” CPU ìì›ì„ ë‚­ë¹„í•˜ëŠ” Busy Waiting ë¬¸ì œë‹¤.
  - ì†Œë¹„ì ìŠ¤ë ˆë“œê°€ ì§ì ‘ í™•ì¸í•˜ì§€ ì•Šê³ , ëˆ„êµ°ê°€ ì•Œë ¤ì£¼ëŠ” ë°©ì‹(íì— ë°ì´í„°ê°€ ì¶”ê°€ë  ë•Œê¹Œì§€ ì†Œë¹„ì ìŠ¤ë ˆë“œëŠ” ëŒ€ê¸° ìƒíƒœê°€ ë  ìˆ˜ ìˆìŒ)ìœ¼ë¡œ ê°œì„ í•  ìˆ˜ ìˆë‹¤. â†’ ì´ë²¤íŠ¸ or ì¡°ê±´ ë³€ìˆ˜ë¥¼ í™œìš©


> ğŸ’¡ Busy Waitingì´ë€?
>
> ìŠ¤ë ˆë“œë‚˜ í”„ë¡œì„¸ìŠ¤ê°€ íŠ¹ì • ì¡°ê±´ì´ ì¶©ì¡±(e.g. ë½ì´ í•´ì œ, ë°ì´í„° ë„ì°© ë“±)ë  ë•Œê¹Œì§€ ë¬´í•œ ë£¨í”„ë¥¼ ëŒë©´ì„œ ì¡°ê±´ì„ í™•ì¸í•˜ëŠ” ë°©ì‹ì´ë‹¤.
>
> ìŠ¤ë ˆë“œê°€ ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜ë˜ì§€ ì•Šê³  ê³„ì† ì‹¤í–‰ ìƒíƒœë¥¼ ìœ ì§€í•˜ë¯€ë¡œ, CPU ìì›ì„ ë¶ˆí•„ìš”í•˜ê²Œ ì†Œëª¨í•œë‹¤.

---

### Event

ìš´ì˜ì²´ì œì—ì„œ ì œê³µí•˜ëŠ” ì»¤ë„ ì˜¤ë¸Œì íŠ¸(HANDLE) ë¥¼ í™œìš©í•˜ë©´, ë½ì´ í’€ë¦´ ë•Œê¹Œì§€ ì§ì ‘ í™•ì¸í•˜ì§€ ì•Šê³ ìš´ì˜ì²´ì œê°€ ì‹ í˜¸(Signal)ë¥¼ ë³´ë‚´ë„ë¡ í•  ìˆ˜ ìˆë‹¤.

> `HANDLE hEvent`ëŠ” íŠ¹ì • ì»¤ë„ ì˜¤ë¸Œì íŠ¸ë¥¼ ì§€ì¹­í•˜ëŠ” ì •ìˆ˜ì´ë‹¤.
>
> ì»¤ë„ ì˜¤ë¸Œì íŠ¸ëŠ” ìœ ì € ë ˆë²¨ì—ì„œ ê´€ë¦¬í•˜ëŠ” ì˜¤ë¸Œì íŠ¸ì™€ ë‹¬ë¦¬, ìš´ì˜ì²´ì œê°€ ê´€ë¦¬í•˜ëŠ” ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë„ë¡ ìš”ì²­í•œë‹¤.

&nbsp; 

ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•œ ì½”ë“œë¥¼ ì‚´í´ë³´ì.

```cpp
std::mutex m;
std::queue<int> q;
HANDLE hEvent;

void Producer()
{
	while (true)
	{
		std::unique_lock<std::mutex> lock(m);
		q.push(100);

		// ë°ì´í„°ë¥¼ ë„£ì€ í›„ ì´ë²¤íŠ¸ ì‹ í˜¸ ì„¤ì •
		::SetEvent(hEvent);

		std::this_thread::sleep_for(100ms);
	}
}

void Consumer()
{
	while (true)
	{
		// ì´ë²¤íŠ¸ ì‹ í˜¸ê°€ ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸° (ë¬´í•œ ëŒ€ê¸°)
		::WaitForSingleObject(hEvent, INFINITE);

		std::unique_lock<std::mutex> lock(m);
		if (q.empty() == false)
		{
			int data = q.front();
			q.pop();
			std::cout << data << std::endl;
		}
	}
}

int main()
{
	// ì»¤ë„ ì˜¤ë¸Œì íŠ¸ ìƒì„± (ì´ë²¤íŠ¸ ì´ˆê¸°í™”)
	hEvent = ::CreateEvent(NULL, FALSE, FALSE, NULL);

	std::thread t1(Producer);
	std::thread t2(Consumer);

	t1.join();
	t2.join();

	::CloseHandle(hEvent);
}
```

- ì´ë²¤íŠ¸ì˜ ì¥ë‹¨ì 
  - ì¥ì 
    - Busy Waiting ë¬¸ì œ í•´ê²° - ìŠ¤ë ˆë“œê°€ ì§ì ‘ ë½ì„ í™•ì¸í•˜ì§€ ì•Šê³ , ì´ë²¤íŠ¸ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ê¸° ë•Œë¬¸ì— CPU ìì›ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
    - ì»¤ë„ ì˜¤ë¸Œì íŠ¸ì´ê¸° ë•Œë¬¸ì— í”„ë¡œì„¸ìŠ¤ ê°„ ë™ê¸°í™”ì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
  - ë‹¨ì 
    - ìš´ì˜ì²´ì œê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„ ì˜¤ë¸Œì íŠ¸ì´ë¯€ë¡œ ë¹„ìš©ì´ ë°œìƒí•œë‹¤.
    - ì´ë²¤íŠ¸ë¥¼ ê³¼ë„í•˜ê²Œ ì‚¬ìš©í•˜ë©´ ì»¤ë„ ì˜¤ë¸Œì íŠ¸ ê´€ë¦¬ ë¹„ìš©ì´ ì¦ê°€í•´ ì„±ëŠ¥ì´ ì €í•˜ë  ìˆ˜ ìˆë‹¤.

---

### Condition Variable

ì¡°ê±´ ë³€ìˆ˜ëŠ” ìš´ì˜ì²´ì œê°€ ì•„ë‹Œ ìœ ì € ë ˆë²¨ì—ì„œ ê´€ë¦¬í•˜ëŠ” ì˜¤ë¸Œì íŠ¸ì´ë‹¤. ì´ë²¤íŠ¸ì™€ ì‚¬ìš© ë°©ì‹ì€ ë¹„ìŠ·í•˜ì§€ë§Œ, ì»¤ë„ ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ì„±ëŠ¥ ë¶€ë‹´ì´ ì ë‹¤.

&nbsp;

ì¡°ê±´ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•œ ì½”ë“œë¥¼ ì‚´í´ë³´ì. 

```cpp
std::mutex m;
std::queue<int> q;
std::condition_variable cv;

void Producer()
{
	while (true)
	{
		{
			std::unique_lock<std::mutex> lock(m);
			q.push(100);
		}

		// ì¡°ê±´ ë³€ìˆ˜ ì•Œë¦¼
		cv.notify_one();
		std::this_thread::sleep_for(100ms);
	}
}

void Consumer()
{
	while (true)
	{
		std::unique_lock<std::mutex> lock(m);
		
		// ì¡°ê±´ì„ ë§Œì¡±í•  ë•Œê¹Œì§€ ëŒ€ê¸° (ë½ì„ ìë™ìœ¼ë¡œ í’€ì—ˆë‹¤ê°€ ê¹¨ì–´ë‚  ë•Œ ë‹¤ì‹œ ì¡ìŒ)
		cv.wait(lock, []() { return q.empty() == false; });

		{
			int data = q.front();
			q.pop();
			std::cout << data << std::endl;
		}
	}
}

int main()
{
	std::thread t1(Producer);
	std::thread t2(Consumer);

	t1.join();
	t2.join();
}
```

- ì¡°ê±´ ë³€ìˆ˜ì˜ ì¥ë‹¨ì 
  - ì¥ì 
    - Busy Waiting ë¬¸ì œ í•´ê²° - ì¡°ê±´ ë³€ìˆ˜ëŠ” ìŠ¤ë ˆë“œê°€ ì¡°ê±´ì„ ë§Œì¡±í•  ë•Œê¹Œì§€ ëŒ€ê¸° ìƒíƒœë¡œ ë“¤ì–´ê°€ê¸° ë•Œë¬¸ì— CPU ìì›ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
    - ì´ë²¤íŠ¸ì™€ ìœ ì‚¬í•˜ì§€ë§Œ, ìš´ì˜ì²´ì œ ê°œì… ì—†ì´ ìœ ì € ë ˆë²¨ì—ì„œ ë™ì‘í•œë‹¤. (ì»¤ë„ ëª¨ë“œ ì „í™˜ ë¹„ìš©ì´ ì—†ìŒ)
    - ìŠ¤ë ˆë“œê°€ ì§ì ‘ lockì„ í™•ì¸í•˜ì§€ ì•Šì•„ busy waiting ë¬¸ì œë¥¼ í•´ê²°í•œë‹¤.
    - ìš´ì˜ì²´ì œì—ì„œ ê´€ë¦¬í•˜ëŠ” ì»¤ë„ ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë¹„ìš©ì´ ì ˆê°ëœë‹¤.
  - ë‹¨ì 
    - ì»¤ë„ ì˜¤ë¸Œì íŠ¸ê°€ í•„ìš”í•œ ìƒí™©(e.g. í”„ë¡œì„¸ìŠ¤ ê°„ ë™ê¸°í™”)ì—ì„œëŠ” ì¡°ê±´ ë³€ìˆ˜ë¡œ ëŒ€ì²´í•  ìˆ˜ ì—†ë‹¤.
    - íŠ¹ì • ìƒí™©ì—ì„œëŠ” ì»¤ë„ ì˜¤ë¸Œì íŠ¸ê°€ ë” ì í•©í•  ìˆ˜ ìˆë‹¤.

---

## ë§ˆì¹˜ë©°

- ê¸°ì–µí•  ê²ƒ 
  - ìŠ¤í•€ë½ì²˜ëŸ¼ ê³„ì† í™•ì¸í•˜ë©° ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  "ëˆ„êµ°ê°€ ì•Œë ¤ì£¼ëŠ” ë°©ì‹"ì„ ì‚¬ìš©í•˜ë©´ CPU ìì›ì„ ì•„ë‚„ ìˆ˜ ìˆë‹¤.
  - ë‚˜ì¤‘ì— í•„ìš”í•  ë•Œ êµ¬ê¸€ë§ í•´ì„œ êµ¬í˜„í•  ìˆ˜ë§Œ ìˆìœ¼ë©´ ëœë‹¤.

--- 

*ì¶œì²˜*
*[Rookissë‹˜ ê²Œì„ í”„ë¡œê·¸ë˜ë¨¸ ì…ë¬¸ ì˜¬ì¸ì›](https://www.inflearn.com/course/%EA%B2%8C%EC%9E%84-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%A8%B8-%EC%9E%85%EB%AC%B8-%EC%98%AC%EC%9D%B8%EC%9B%90-rookiss/dashboard)*