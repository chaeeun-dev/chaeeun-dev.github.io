---
title: "[Server] #15-10. ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°"
excerpt: ""

categories:
  - Server
tags:
  - [Server]

permalink: /theory/server/smart-pointer/

toc: true
toc_sticky: true

date: 2024-11-14
last_modified_at: 2025-03-19
---

## ë“¤ì–´ê°€ë©°

ìƒ í¬ì¸í„°(raw pointer)ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ë©´ ê°ì²´ì˜ ìƒëª… ì£¼ê¸° ê´€ë¦¬ê°€ ì–´ë ¤ì›Œì§€ê³ , ë©”ëª¨ë¦¬ ì´ìŠˆê°€ ë°œìƒí•  í™•ë¥ ì´ ë†’ë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í¬ì¸í„°ë¥¼ ê´€ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤. ì´ë²ˆ ìˆ˜ì—…ì—ì„œëŠ” ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ë¥¼ ì§ì ‘ ê´€ë¦¬í•˜ëŠ” ì‹¤ìŠµê³¼ ìŠ¤ë§ˆíŠ¸ í¬ì¸í„° ì‹¤ìŠµì„ í†µí•´ ë©”ëª¨ë¦¬ë¥¼ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì„ ë°°ìš´ë‹¤.

---

## ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ ìˆ˜ë™ ê´€ë¦¬

ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸(Reference Count) ë°©ì‹ì€ ê°ì²´ê°€ ëª‡ ê°œì˜ í¬ì¸í„°ì— ì˜í•´ ì°¸ì¡°ë˜ê³  ìˆëŠ”ì§€ ì¶”ì í•˜ì—¬, ë” ì´ìƒ ì°¸ì¡°ë˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ê°ì²´ë¥¼ ì‚­ì œí•˜ëŠ” ë°©ë²•ì´ë‹¤.

ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ë¥¼ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì€ í¬ê²Œ ë‘ ê°€ì§€ê°€ ìˆë‹¤.
1. ê°ì²´ ë‚´ë¶€ì— í¬í•¨í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” ë°©ì‹
2. ë³„ë„ì˜ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´í„° ë¸”ë¡ì„ ìƒì„±í•˜ëŠ” ë°©ì‹

&nbsp;

`RefCountable` í´ë˜ìŠ¤ë¥¼ í†µí•´ ìˆ˜ë™ìœ¼ë¡œ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ë¥¼ ê´€ë¦¬í•´ë³¸ë‹¤.

```cpp
class RefCountable
{
public:
	RefCountable() {}
	virtual ~RefCountable() {}

	int GetRefCount() { return _refCount; }
	int AddRef() { return ++_refCount; }
	int ReleaseRef()
	{
		int refCount = --_refCount;
		if (refCount == 0)
			delete this;
		
		return refCount;
	}

protected:
	int _refCount = 1;
};
```

- `refCount` ê°’ì„ ì¦ê°€/ê°ì†Œì‹œì¼œ í˜„ì¬ ì°¸ì¡° ê°œìˆ˜ë¥¼ ì¶”ì í•œë‹¤.
- ì°¸ì¡° ê°œìˆ˜ê°€ 0ì´ ë˜ë©´ ìë™ìœ¼ë¡œ `delete`ê°€ ìˆ˜í–‰ëœë‹¤.

&nbsp;

ì´ì œ `RefCountable`ì„ ìƒì†ë°›ì•„ ê°ì²´ë¥¼ ê´€ë¦¬í•´ë³¸ë‹¤.

```cpp
class Knight : public RefCountable
{
public:

};

std::map<int, Knight*> _knights;

int main() 
{
	Knight* knight = new Knight();	// _refCount == 1

	_knights[100] = knight;
	knight->AddRef();		// _refCount == 2;

	_knights.erase(100);
	knight->ReleaseRef();	// _refCount == 1
	knight = nullptr;
}
```

&nbsp;

- ë©€í‹° ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œ
    - `refCount` ì¦ê°€/ê°ì†Œ ì—°ì‚°ì€ 3ë‹¨ê³„(ì½ê¸° â†’ ìˆ˜ì • â†’ ì €ì¥)ë¡œ ì´ë£¨ì–´ì§€ë¯€ë¡œ, **ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•  ê²½ìš° ê°’ì´ ê¼¬ì¼ ìˆ˜ ìˆë‹¤.** ([#15-5. ê³µìœ  ìì›](https://chaeeun-dev.github.io/theory/server/shared-resource/#%EC%8B%A4%EC%8A%B52---atomic%EC%9C%BC%EB%A1%9C-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0) atomic ë‚´ìš© ì°¸ê³ ) â†’ `std::atomic<int> _refCount = 1;`ë¡œ ë³€ê²½ í•„ìš”
    - `Knightâ†’AddRef();` í˜¸ì¶œ ì „ì— ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ `ReleaseRef()`ë¥¼ í˜¸ì¶œí•˜ì—¬ ê°ì²´ê°€ ì‚­ì œë  ìœ„í—˜ì´ ìˆë‹¤.
- ê²°ë¡ 
    - **ìˆ˜ë™ìœ¼ë¡œ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ë¥¼ ê´€ë¦¬í•˜ì§€ ë§ì.** 
    - `std::atomic`ì„ ì‚¬ìš©í•´ë„ êµì°© ìƒíƒœ(DeadLock)ë‚˜ ë°ì´í„° ê²½í•©(Race Condition) ë¬¸ì œë¥¼ ì™„ì „íˆ í•´ê²°í•  ìˆ˜ ì—†ë‹¤.

---

## ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°

ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ëŠ” **ê°ì²´ê°€ ë³µì‚¬ë  ë•Œ RefCountë¥¼ ìë™ìœ¼ë¡œ ì¦ê°€**ì‹œì¼œ ì¤‘ê°„ì— ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ê°œì…í•´ë„ ê°ì²´ê°€ ì†Œë©¸ë˜ì§€ ì•Šë„ë¡ ë³´ì¥í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. 

&nbsp;

ìŠ¤ë§ˆíŠ¸ í¬ì¸í„° ì£¼ì˜í•  ì 
- ìˆœí™˜ ì°¸ì¡° ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ (`shared_ptr`ì´ ì„œë¡œë¥¼ ì°¸ì¡°í•˜ë©´ ì°¸ì¡° ì¹´ìš´íŠ¸ê°€ 0ì´ ë˜ì§€ ì•Šì•„ ê°ì²´ê°€ ì‚­ì œë˜ì§€ ì•ŠëŠ” ë¬¸ì œ) â†’ `weak_ptr`ë¡œ í•´ê²°
- `shared_ptr`ì—ì„œ this í¬ì¸í„° ì‚¬ìš© ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ (í´ë˜ìŠ¤ ë‚´ë¶€ì—ì„œ `shared_ptr`ì„ ì§ì ‘ ì‚­ì œí•˜ë©´ ì´ì¤‘ í•´ì œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ)

&nbsp;

> ğŸ’¡`weak_ptr`ì´ ìˆœí™˜ ì°¸ì¡°ë¥¼ ë°©ì§€í•˜ëŠ” ë°©ë²•
>
> - `shared_ptr`ì´ ë³µì‚¬ë  ëŒ€ ì»¨íŠ¸ë¡¤ ë¸”ë¡ì˜ RefCountê°€ ì¦ê°€í•˜ê³ , ë§ˆì§€ë§‰ `shared_ptr`ì´ ì†Œë©¸ë˜ë©´ RefCountê°€ 0ì´ ë˜ì–´ ê°ì²´ë„ ìë™ ì‚­ì œëœë‹¤.
> - `weak_ptr`ì€ RefCountë¥¼ ì¦ê°€ì‹œí‚¤ì§€ ì•Šê³  ì»¨íŠ¸ë¡¤ ë¸”ë¡ì„ ìœ ì§€í•˜ì—¬ ìˆœí™˜ ì°¸ì¡° ë¬¸ì œë¥¼ ë°©ì§€í•œë‹¤.

&nbsp;

> ğŸ’¡ ì»¨íŠ¸ë¡¤ ë¸”ëŸ­ì´ë€?
>
> ì»¨íŠ¸ë¡¤ ë¸”ë¡ì—ëŠ” ê°ì²´ë¥¼ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì •ë³´ê°€ í¬í•¨ë¼ ìˆë‹¤. `shared_ptr`ì´ ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ, ì‹¤ì œ ê°ì²´ ì™¸ì— RefCountë¥¼ í¬í•¨í•œ ì»¨íŠ¸ë¡¤ ë¸”ë¡ì„ ìƒì„±í•œë‹¤. 
> 1. RefCount: `shared_ptr`ì´ ëª‡ ê°œ ì¡´ì¬í•˜ëŠ”ì§€ ì¶”ì 
> 2. ê°ì²´ í¬ì¸í„°: ì‹¤ì œë¡œ ê´€ë¦¬í•˜ëŠ” ê°ì²´
> 3. WeakCount: `weak_ptr`ì´ ëª‡ ê°œ ì¡´ì¬í•˜ëŠ”ì§€ ì¶”ì  (ìˆœí™˜ ì°¸ì¡° ë¬¸ì œ í•´ê²°)

---

## ë§ˆì¹˜ë©°

- ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ë¥¼ ì‚¬ìš©í•˜ë©´ ìˆ˜ë™ ë©”ëª¨ë¦¬ ê´€ë¦¬ë³´ë‹¤ ì•ˆì „í•˜ê³  í¸ë¦¬í•˜ë‹¤.
- ìˆœí™˜ ì°¸ì¡° ë¬¸ì œì™€ this í¬ì¸í„° ë¬¸ì œë¥¼ ì£¼ì˜í•˜ì.

--- 

*ì¶œì²˜*
*[Rookissë‹˜ ê²Œì„ í”„ë¡œê·¸ë˜ë¨¸ ì…ë¬¸ ì˜¬ì¸ì›](https://www.inflearn.com/course/%EA%B2%8C%EC%9E%84-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%A8%B8-%EC%9E%85%EB%AC%B8-%EC%98%AC%EC%9D%B8%EC%9B%90-rookiss/dashboard)*