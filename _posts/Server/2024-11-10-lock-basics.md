---
title: "[Server] #15-6. Lock ê¸°ì´ˆ"
excerpt: "Mutexì™€ RAII ê°œë…ì„ ì´í•´í•˜ê³  LockGuard ì‚¬ìš©í•˜ê¸°"

categories:
  - Server
tags:
  - [Server, Lock, LockGuard, Mutex, RAII]

permalink: /theory/server/lock-basics/

toc: true
toc_sticky: true

date: 2024-11-10
last_modified_at: 2025-03-12
---

## Mutex

C++ì—ì„œ mutexëŠ” **mutal exclusion(ìƒí˜¸ ë°°ì œ)**ë¥¼ ì˜ë¯¸í•˜ë©°, í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

- ì‚¬ìš© ë°©ë²•

```cpp
#include <mutex>

std::mutex m;
```

---

### ì‹¤ìŠµ1 - Mutexê°€ ì—†ìœ¼ë©´ ë°œìƒí•˜ëŠ” ë¬¸ì œ

ë‹¤ìŒ ì½”ë“œì˜ ê²°ê³¼ë¥¼ ì˜ˆì¸¡í•´ë³´ì.
1. 20000
2. Crash ë°œìƒ
3. ì´ìƒí•œ ê°’

```cpp
#include <vector>
#include <thread>
#include <iostream>

std::vector<int> v;

void Push()
{
    for (int i = 0; i < 10000; i++)
    {
        v.push_back(i);
    }
}

int main()
{
    std::thread t1(Push);
    std::thread t2(Push);

    t1.join();
    t2.join();

    std::cout << v.size() << std::endl;
}
```

- ê²°ê³¼
    1. Crashê°€ ë°œìƒí•œë‹¤. 
    2. ì´ìƒí•œ ê°’ì´ ë‚˜ì˜¨ë‹¤. (`vector.reverse(1000000)`ì„ ì‚¬ìš©í•´ ì´ì‚¬ íšŸìˆ˜ë¥¼ ì¤„ì˜€ì„ ë•Œ)
- ì›ì¸
    1. `push_back()`ì„ í˜¸ì¶œí•  ë•Œ ë°ì´í„°ê°€ ê°€ë“ ì°¨ë©´ ì´ì‚¬(rellocation)ê°€ ë°œìƒí•˜ëŠ”ë°, í•œ ìŠ¤ë ˆë“œê°€ vectorì˜ ë©”ëª¨ë¦¬ë¥¼ ì¬í• ë‹¹í•˜ë©´ì„œ ê¸°ì¡´ì˜ ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•˜ëŠ” ìˆœê°„ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ í•´ì œëœ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•˜ë©´ í¬ë˜ì‹œê°€ ë°œìƒí•œë‹¤.
    2. `vector`ëŠ” ë™ì  ë°°ì—´ë¡œ Heap ì˜ì—­ì— í• ë‹¹ë˜ë¯€ë¡œ ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— `push_back()`ì„ ì‹¤í–‰í•˜ë©° ê°™ì€ ë©”ëª¨ë¦¬ ìœ„ì¹˜ë¥¼ ë®ì–´ì“´ë‹¤.
- í•´ê²° ë°©ë²•
    - `mutex`ë¥¼ ì‚¬ìš©í•˜ì—¬ `push_back()`ì´ ë™ì‹œì— ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ë³´í˜¸í•œë‹¤.

---

### ì‹¤ìŠµ2 - Mutexë¥¼ ì´ìš©í•œ ë¬¸ì œ í•´ê²°

í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ `lock`ìœ¼ë¡œ ì ê¸ˆì„ ê±¸ê³ , ì‘ì—…ì´ ëë‚˜ë©´ `unlock`ìœ¼ë¡œ ì ê¸ˆì„ í’€ì–´ì¤€ë‹¤.

```cpp
#include <vector>
#include <thread>
#include <iostream>
#include <mutex>

std::vector<int> v;
std::mutex m;

void Push()
{
    for (int i = 0; i < 10000; i++)
    {
        m.lock();
        v.push_back(i);
        m.unlock();
    }
}

int main()
{
    std::thread t1(Push);
    std::thread t2(Push);

    t1.join();
    t2.join();

    std::cout << v.size() << std::endl;  // ì •ìƒì ìœ¼ë¡œ 20000 ì¶œë ¥
}
```

- ê²°ê³¼
    - `v.size() == 20000`ì´ ì •ìƒì ìœ¼ë¡œ ì¶œë ¥ëœë‹¤.
    - `push_back()`ì´ í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œì—ì„œë§Œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥ëœë‹¤.
- Mutex ë™ì‘ ë°©ì‹
    - `m.lock()`: ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ ì ê·¼ë‹¤.
    - `m.unlock()`: ì‘ì—…ì´ ëë‚œ í›„ ì ê¸ˆì„ í•´ì œí•œë‹¤.
    - lockì„ ì œëŒ€ë¡œ í•´ì œí•˜ì§€ ì•Šìœ¼ë©´ í”„ë¡œê·¸ë¨ì´ ë©ˆì¶”ëŠ” ë°ë“œë½(ë¬´í•œ ëŒ€ê¸°)ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤. 
    - ì°¸ê³ . ìŠ¤ë ˆë“œê°€ ì‹¤í–‰ë˜ëŠ” ìˆœì„œëŠ” ì•Œ ìˆ˜ ì—†ë‹¤.

---

### ì‹¤ìŠµ3 - RAII íŒ¨í„´

- RAII(Resource Acquisition Is Initialization) íŒ¨í„´ì„ ì‚¬ìš©í•˜ë©´ `lock()`ê³¼ `unlock()`ì„ ì§ì ‘ í˜¸ì¶œí•  í•„ìš” ì—†ì´ ìë™ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.
- ìì›ì„ ìˆ˜ë™ìœ¼ë¡œ í• ë‹¹í•˜ê³  í•´ì œí•˜ë©´(`lock` & `unlock`) ì˜ˆì™¸ ë°œìƒì‹œ ìì› í•´ì œë¥¼ ê¹œë¹¡í•´ì„œ mutexê°€ ì˜êµ¬ì ìœ¼ë¡œ ì ê¸¸ ìˆ˜ ìˆë‹¤. RAII íŒ¨í„´ì„ ì ìš©í•˜ë©´ ë” ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.

> ğŸ’¡ RAII(Resource Acquisition Is Initialization)ì´ë€?
>
> ê°ì²´ì˜ ìƒëª… ì£¼ê¸°ì™€ ìì›ì˜ ê´€ë¦¬ë¥¼ ì—°ê´€ì‹œì¼œ, ìì›ì˜ ëˆ„ìˆ˜ë¥¼ ë°©ì§€í•˜ëŠ” C++ í”„ë¡œê·¸ë˜ë° ê¸°ë²•ì´ë‹¤. 
> - ê°ì²´ê°€ ìƒì„±ë  ë•Œ ìì›ì„ íšë“í•˜ê³ , ê°ì²´ê°€ ì†Œë©¸ë  ë•Œ ìì›ì„ ìë™ìœ¼ë¡œ ë°˜í™˜í•˜ë„ë¡ ì„¤ê³„í•œë‹¤.
> - C++ì˜ ìŠ¤ì½”í”„ ê¸°ë°˜ ìë™ í•´ì œ(ìë™ ì •ë¦¬) ê°œë…ì„ í™œìš©í•œë‹¤.
> - `std::lock_guard`, `std::unique_lock`, `std::shared_ptr` ë“±ì˜ í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë„ RAII ì›ì¹™ì„ ë”°ë¥¸ë‹¤.

&nbsp;

- ì§ì ‘ êµ¬í˜„í•˜ê¸°
    - í…œí”Œë¦¿ì„ ì‚¬ìš©í•´ `lockGuard` ê°ì²´ê°€ ìƒì„±ë  ë•Œ `lock()`ì„ í˜¸ì¶œí•˜ê³ , ì†Œë©¸ë  ë•Œ `unlock()`ì„ ìë™ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤.

```cpp
template<typename T>
class LockGuard
{
public:
    LockGuard(T& m) : _mutex(m)
    {
        _mutex.lock();
    }

    ~LockGuard()
    {
        _mutex.unlock();
    }

private:
    T& _mutex;
};

void Push()
{
    for (int i = 0; i < 10000; i++)
    {
        LockGuard<std::mutex> lockGuard(m);
        v.push_back(i);
    }
}
```

&nbsp;

- í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©í•˜ê¸°
    - C++ í‘œì¤€ì—ì„œ `std::lock_guard`ë¥¼ ì œê³µí•˜ë¯€ë¡œ `LockGuard`ë¥¼ ì§ì ‘ ë§Œë“¤ì§€ ì•Šì•„ë„ ëœë‹¤.
    - ìë™ìœ¼ë¡œ `lock()`ê³¼ `unlock()`ì„ ê´€ë¦¬í•´ì£¼ë¯€ë¡œ ë°ë“œë½ì„ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.
```cpp
void Push()
{
    for (int i = 0; i < 10000; i++)
    {
        std::lock_guard<std::mutex> lockGuard(m);
        v.push_back(i);
    }
}
```

--- 

### ì‹¤ìŠµ4 - unique_lock

`std::lock_guard`ì™€ ìœ ì‚¬í•˜ì§€ë§Œ, `lock()`ì„ ë‚˜ì¤‘ì— í˜¸ì¶œí•˜ê±°ë‚˜, ì¡°ê±´ì— ë”°ë¼ í•´ì œí•˜ëŠ” ê¸°ëŠ¥ì´ í•„ìš”í•  ë•Œ ì‚¬ìš©í•œë‹¤. 

```cpp
void Push()
{
    for (int i = 0; i < 10000; i++)
    {
        std::unique_lock<std::mutex> lock(m);
        v.push_back(i);
        lock.unlock();  // ì¤‘ê°„ì— ì ê¸ˆì„ í•´ì œí•  ìˆ˜ë„ ìˆìŒ
    }
}
```

---

## ë§ˆì¹˜ë©°

- ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ lockì—†ì´ `vector` ê°™ì€ STL ì»¨í…Œì´ë„ˆì— ì ‘ê·¼í•˜ëŠ” ì½”ë“œë¥¼ ë³´ë©´ ë°”ë¡œ ë¬¸ì œë¥¼ ì•Œì•„ì±Œ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. 
- lockì„ ë‚¨ë°œí•˜ë©´ ì˜¤íˆë ¤ ì„±ëŠ¥ì´ ë‚˜ë¹ ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ ì ì ˆíˆ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

--- 

*ì¶œì²˜*
*[Rookissë‹˜ ê²Œì„ í”„ë¡œê·¸ë˜ë¨¸ ì…ë¬¸ ì˜¬ì¸ì›](https://www.inflearn.com/course/%EA%B2%8C%EC%9E%84-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%A8%B8-%EC%9E%85%EB%AC%B8-%EC%98%AC%EC%9D%B8%EC%9B%90-rookiss/dashboard)*